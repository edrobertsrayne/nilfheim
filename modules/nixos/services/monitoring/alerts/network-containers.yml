groups:
  - name: network.health.alerts
    rules:
      # Network Interface Down
      - alert: HostNetworkInterfaceDown
        expr: node_network_up{device!~"lo|veth.*|br-.*|docker.*|tailscale.*"} == 0
        for: 2m
        labels:
          severity: warning
          component: network
        annotations:
          summary: "Network interface is down"
          description: "Network interface {{ $labels.device }} on {{ $labels.instance }} is down."

      # Network Receive Errors
      - alert: HostNetworkReceiveErrors
        expr: rate(node_network_receive_errs_total{device!~"lo|veth.*|br-.*|docker.*"}[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: network
        annotations:
          summary: "Network interface receiving errors"
          description: "Interface {{ $labels.device }} on {{ $labels.instance }} has {{ $value | humanize }} receive errors/sec."

      # Network Transmit Errors
      - alert: HostNetworkTransmitErrors
        expr: rate(node_network_transmit_errs_total{device!~"lo|veth.*|br-.*|docker.*"}[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: network
        annotations:
          summary: "Network interface transmit errors"
          description: "Interface {{ $labels.device }} on {{ $labels.instance }} has {{ $value | humanize }} transmit errors/sec."

      # Network Receive Drops
      - alert: HostNetworkReceiveDrops
        expr: rate(node_network_receive_drop_total{device!~"lo|veth.*|br-.*|docker.*"}[5m]) > 50
        for: 5m
        labels:
          severity: warning
          component: network
        annotations:
          summary: "Network interface dropping received packets"
          description: "Interface {{ $labels.device }} on {{ $labels.instance }} is dropping {{ $value | humanize }} received packets/sec."

      # Network Transmit Drops
      - alert: HostNetworkTransmitDrops
        expr: rate(node_network_transmit_drop_total{device!~"lo|veth.*|br-.*|docker.*"}[5m]) > 50
        for: 5m
        labels:
          severity: warning
          component: network
        annotations:
          summary: "Network interface dropping transmit packets"
          description: "Interface {{ $labels.device }} on {{ $labels.instance }} is dropping {{ $value | humanize }} transmit packets/sec."

  - name: container.health.alerts
    rules:
      # Container Down
      - alert: ContainerDown
        expr: absent(container_last_seen{name=~"homeassistant|portainer|tdarr"})
        for: 5m
        labels:
          severity: critical
          component: containers
        annotations:
          summary: "Container {{ $labels.name }} is down"
          description: "Container {{ $labels.name }} has been down for 5 minutes."

      # Container High Memory Usage
      - alert: ContainerHighMemory
        expr: (container_memory_usage_bytes{name=~"homeassistant|portainer|tdarr"} / container_spec_memory_limit_bytes * 100) > 90
        for: 5m
        labels:
          severity: warning
          component: containers
        annotations:
          summary: "Container memory usage high"
          description: "Container {{ $labels.name }} is using {{ $value | humanize }}% of memory limit."

      # Container High CPU Usage
      - alert: ContainerHighCPU
        expr: (rate(container_cpu_usage_seconds_total{name=~"homeassistant|portainer|tdarr"}[5m]) * 100) > 80
        for: 10m
        labels:
          severity: warning
          component: containers
        annotations:
          summary: "Container CPU usage high"
          description: "Container {{ $labels.name }} is using {{ $value | humanize }}% CPU for 10 minutes."

      # Container Restarting
      - alert: ContainerRestarting
        expr: rate(container_last_seen{name=~"homeassistant|portainer|tdarr"}[15m]) > 0.01
        for: 5m
        labels:
          severity: warning
          component: containers
        annotations:
          summary: "Container is restarting frequently"
          description: "Container {{ $labels.name }} has restarted multiple times in the last 15 minutes."

      # Container Unhealthy
      - alert: ContainerUnhealthy
        expr: container_health_status{name=~"homeassistant|portainer|tdarr",health_status!="healthy"} == 1
        for: 2m
        labels:
          severity: warning
          component: containers
        annotations:
          summary: "Container health check failing"
          description: "Container {{ $labels.name }} health status is {{ $labels.health_status }}."
