groups:
  - name: zfs.snapshots.alerts
    rules:
      # No snapshots created recently
      - alert: ZFSSnapshotStale
        expr: (time() - zfs_snapshot_last_success) > 86400 * 2  # 2 days
        for: 1h
        labels:
          severity: warning
          component: backup
        annotations:
          summary: "ZFS snapshots are stale"
          description: "No successful snapshots for dataset {{ $labels.dataset }} ({{ $labels.type }}) in the last 2 days."

      # Snapshot creation failures
      - alert: ZFSSnapshotFailed
        expr: increase(zfs_snapshot_failed[1h]) > 0
        for: 0m
        labels:
          severity: critical
          component: backup
        annotations:
          summary: "ZFS snapshot creation failed"
          description: "Failed to create {{ $labels.type }} snapshot for dataset {{ $labels.dataset }}."

      # Snapshot cleanup failures
      - alert: ZFSSnapshotCleanupFailed
        expr: increase(zfs_snapshot_cleanup_failed[1h]) > 0
        for: 0m
        labels:
          severity: warning
          component: backup
        annotations:
          summary: "ZFS snapshot cleanup failed"
          description: "Failed to clean up old {{ $labels.type }} snapshots for dataset {{ $labels.dataset }}."

      # Too few snapshots (might indicate cleanup is too aggressive)
      - alert: ZFSSnapshotCountLow
        expr: zfs_snapshot_count < 1
        for: 6h
        labels:
          severity: warning
          component: backup
        annotations:
          summary: "Very few ZFS snapshots"
          description: "Dataset {{ $labels.dataset }} has only {{ $value }} {{ $labels.type }} snapshots, which might indicate cleanup issues."

      # Too many snapshots (might indicate cleanup is failing)
      - alert: ZFSSnapshotCountHigh
        expr: |
          (zfs_snapshot_count{type="daily"} > 30) or
          (zfs_snapshot_count{type="weekly"} > 20) or  
          (zfs_snapshot_count{type="monthly"} > 12)
        for: 1h
        labels:
          severity: warning
          component: backup
        annotations:
          summary: "Too many ZFS snapshots"
          description: "Dataset {{ $labels.dataset }} has {{ $value }} {{ $labels.type }} snapshots, cleanup might be failing."

      # No snapshots at all for a configured dataset
      - alert: ZFSSnapshotMissing
        expr: zfs_snapshot_count == 0
        for: 12h
        labels:
          severity: critical
          component: backup
        annotations:
          summary: "ZFS snapshots completely missing"
          description: "Dataset {{ $labels.dataset }} has no {{ $labels.type }} snapshots at all despite being configured."